<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Редактирование детали: {{ part.name }}</title>
    <style>
        .image-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        .image-item {
            text-align: center;
            position: relative;
        }
        .thumbnail {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .main-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
            font-family: Arial, sans-serif;
        }
        .set-main-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 12px;
            margin-right: 5px;
            font-family: Arial, sans-serif;
        }
        .nav-button {
            display: inline-block;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            text-align: center;
            font-family: Arial, sans-serif;
            font-size: 14px;
            border: none;
            cursor: pointer;
        }
        .form-button {
            padding: 12px 0;
            color: white;
            border: none;
            border-radius: 4px;
            flex: 1;
            cursor: pointer;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .delete-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            transform: scale(1.2);
        }
        .image-item.marked-for-delete .thumbnail {
            opacity: 0.5;
            border-color: #dc3545;
        }
        .file-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .video-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .video-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        .video-item {
            text-align: center;
            position: relative;
        }
        .video-thumbnail {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #000;
        }
        .video-info {
            margin-top: 5px;
            font-size: 12px;
            font-family: Arial, sans-serif;
        }
        .delete-video-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 11px;
        }
        .delete-video-checkbox {
            position: absolute;
            top: 5px;
            right: 5px;
            transform: scale(1.2);
        }
        .video-item.marked-for-delete .video-thumbnail {
            opacity: 0.5;
            border-color: #dc3545;
        }
        .file-list {
            margin-top: 10px;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <h1>Редактирование детали: {{ part.name }}</h1>

    <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
        <a href="/parts/{{ part.id }}" class="nav-button" style="background-color: #6c757d;">
            Назад к детали
        </a>
        <a href="/parts" class="nav-button" style="background-color: #0e298a;">
            К списку
        </a>
        <a href="/" class="nav-button" style="background-color: #20994c;">
            Главная
        </a>
    </div>

    <form action="/parts/{{ part.id }}/edit" method="POST" enctype="multipart/form-data" style="max-width: 800px;" id="editForm">
        <!-- Основные поля -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <div style="margin-bottom: 15px;">
                    <label for="name" style="display: block; margin-bottom: 5px; font-weight: bold;">Название детали:</label>
                    <input type="text" id="name" name="name" value="{{ part.name }}" required
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="car" style="display: block; margin-bottom: 5px; font-weight: bold;">Авто:</label>
                    <input type="text" id="car" name="car" value="{{ part.car }}"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="part_number" style="display: block; margin-bottom: 5px; font-weight: bold;">Кат. номер:</label>
                    <input type="text" id="part_number" name="part_number" value="{{ part.part_number }}" required
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
                </div>
            </div>

            <div>
                <div style="margin-bottom: 15px;">
                    <label for="price_in" style="display: block; margin-bottom: 5px; font-weight: bold;">Цена закупки:</label>
                    <input type="number" id="price_in" name="price_in" value="{{ part.price_in }}" min="0" required
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label for="price_out" style="display: block; margin-bottom: 5px; font-weight: bold;">Цена продажи:</label>
                    <input type="number" id="price_out" name="price_out" value="{{ part.price_out }}" min="0" required
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
                </div>
            </div>
        </div>
        <div style="margin-bottom: 15px;">
        <label for="quantity" style="display: block; margin-bottom: 5px; font-weight: bold;">Количество:</label>
        <input type="number" id="quantity" name="quantity" value="{{ part.quantity }}" min="0" required
           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
        </div>
        <div style="margin-bottom: 20px;">
            <label for="description" style="display: block; margin-bottom: 5px; font-weight: bold;">Комментарии:</label>
            <textarea id="description" name="description" rows="4"
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">{{ part.description }}</textarea>
        </div>

        <!-- Существующие изображения -->
        {% if part.images %}
        <div class="file-section">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Текущие изображения:</label>
            <div class="image-container" id="existing-images">
                {% for image in part.images %}
                <div class="image-item" data-image-id="{{ image.id }}">
                    {% if image.is_main %}
                    <div class="main-badge">Главное</div>
                    {% endif %}
                    <input type="checkbox"
                           class="delete-checkbox"
                           name="delete_images"
                           value="{{ image.id }}"
                           style="display: none;">
                    <img src="{{ url_for('static', filename='uploads/parts/' + part.id|string + '/' + image.filename) }}"
                         alt="{{ part.name }}"
                         class="thumbnail">
                    <div>
                        {% if not image.is_main %}
                        <button type="button" class="set-main-btn" onclick="setAsMain({{ image.id }})">
                            Сделать главным
                        </button>
                        {% endif %}
                        <button type="button" class="delete-btn" onclick="markForDelete({{ image.id }})">
                            Удалить
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Загрузка новых изображений -->
        <div class="file-section">
            <label for="images" style="display: block; margin-bottom: 5px; font-weight: bold;">Добавить новые изображения:</label>
            <input type="file" id="images" name="images" accept="image/*" multiple
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
            <small style="color: #666; font-family: Arial, sans-serif;">
                Можно выбрать несколько файлов. Допустимые форматы: JPG, PNG, GIF, WEBP. Максимальный размер: 20MB на файл.
            </small>
            <div id="image-file-list" class="file-list"></div>
        </div>

        <!-- Существующие видео -->
        {% if part.videos %}
        <div class="video-section">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Текущие видео:</label>
            <div class="video-container" id="existing-videos">
                {% for video in part.videos %}
                <div class="video-item" data-video-id="{{ video.id }}">
                    <input type="checkbox"
                           class="delete-video-checkbox"
                           name="delete_videos"
                           value="{{ video.id }}"
                           style="display: none;">
                    <video class="video-thumbnail" preload="metadata">
                        <source src="{{ url_for('static', filename='uploads/parts/' + part.id|string + '/video/' + video.filename) }}#t=1" type="video/mp4">
                    </video>
                    <div class="video-info">
                        <div>{{ video.original_filename|truncate(20) }}</div>
                        <button type="button" class="delete-video-btn" onclick="markVideoForDelete({{ video.id }})">
                            Удалить
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Загрузка новых видео -->
        <div class="video-section">
            <label for="videos" style="display: block; margin-bottom: 5px; font-weight: bold;">Добавить новые видео:</label>
            <input type="file" id="videos" name="videos" accept="video/*" multiple
                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: Arial, sans-serif;">
            <small style="color: #666; font-family: Arial, sans-serif;">
                Допустимые форматы: MP4, AVI, MOV, WMV, FLV, WEBM, MKV. Максимальный размер: 100MB на файл.
                Можно выбрать несколько файлов (максимум 5)
            </small>
            <div id="video-file-list" class="file-list"></div>
        </div>

        <!-- Скрытое поле для главного изображения -->
        <input type="hidden" id="main_image" name="main_image" value="
            {%- for image in part.images -%}
                {%- if image.is_main -%}
                    {{ image.id }}
                {%- endif -%}
            {%- endfor -%}">

        <div style="display: flex; gap: 10px;">
            <button type="submit" class="form-button" style="background-color: #28a745;">
                Сохранить изменения
            </button>
            <a href="/parts/{{ part.id }}" class="nav-button" style="background-color: #6c757d; text-align: center;">
                Отмена
            </a>
        </div>
    </form>

    <script>
        let formSubmitted = false;

        // Отображение списка выбранных файлов для изображений
        document.getElementById('images').addEventListener('change', function(e) {
            const fileList = document.getElementById('image-file-list');
            fileList.innerHTML = '';

            if (this.files.length > 0) {
                const list = document.createElement('ul');
                list.style.paddingLeft = '20px';
                list.style.marginTop = '10px';
                list.style.fontFamily = 'Arial, sans-serif';

                for (let i = 0; i < this.files.length; i++) {
                    const listItem = document.createElement('li');
                    listItem.textContent = this.files[i].name + ' (' + (this.files[i].size / 1024 / 1024).toFixed(2) + ' MB)';
                    list.appendChild(listItem);
                }

                fileList.appendChild(list);
            }
        });

        // Отображение списка выбранных файлов для видео
        document.getElementById('videos').addEventListener('change', function(e) {
            const fileList = document.getElementById('video-file-list');
            fileList.innerHTML = '';

            if (this.files.length > 0) {
                const list = document.createElement('ul');
                list.style.paddingLeft = '20px';
                list.style.marginTop = '10px';
                list.style.fontFamily = 'Arial, sans-serif';

                for (let i = 0; i < this.files.length; i++) {
                    const listItem = document.createElement('li');
                    listItem.textContent = this.files[i].name + ' (' + (this.files[i].size / 1024 / 1024).toFixed(2) + ' MB)';
                    list.appendChild(listItem);
                }

                fileList.appendChild(list);
            }
        });

        // Помечаем изображение для удаления
        function markForDelete(imageId) {
            const imageItem = document.querySelector(`[data-image-id="${imageId}"]`);
            const checkbox = imageItem.querySelector('.delete-checkbox');

            if (imageItem.classList.contains('marked-for-delete')) {
                // Отменяем удаление
                imageItem.classList.remove('marked-for-delete');
                checkbox.checked = false;
            } else {
                // Помечаем для удаления
                imageItem.classList.add('marked-for-delete');
                checkbox.checked = true;
            }
        }

        // Помечаем видео для удаления
        function markVideoForDelete(videoId) {
            const videoItem = document.querySelector(`[data-video-id="${videoId}"]`);
            const checkbox = videoItem.querySelector('.delete-video-checkbox');

            if (videoItem.classList.contains('marked-for-delete')) {
                // Отменяем удаление
                videoItem.classList.remove('marked-for-delete');
                checkbox.checked = false;
            } else {
                // Помечаем для удаления
                videoItem.classList.add('marked-for-delete');
                checkbox.checked = true;
            }
        }

        // Установка главного изображения
        function setAsMain(imageId) {
            document.getElementById('main_image').value = imageId;

            // Обновляем визуальное отображение
            document.querySelectorAll('.main-badge').forEach(badge => {
                badge.remove();
            });

            document.querySelectorAll('.set-main-btn').forEach(btn => {
                btn.style.display = 'inline-block';
            });

            const currentImage = document.querySelector(`[data-image-id="${imageId}"]`);
            const badge = document.createElement('div');
            badge.className = 'main-badge';
            badge.textContent = 'Главное';
            currentImage.prepend(badge);

            currentImage.querySelector('.set-main-btn').style.display = 'none';
        }

        // Убираем предупреждение при отправке формы
        document.getElementById('editForm').addEventListener('submit', function() {
            formSubmitted = true;
        });

        // Убираем предупреждение при уходе со страницы
        window.addEventListener('beforeunload', function(e) {
            if (!formSubmitted) {
                // Только если форма не отправлена
                const hasChanges = document.getElementById('images').files.length > 0 ||
                                 document.getElementById('videos').files.length > 0 ||
                                 document.querySelectorAll('.delete-checkbox:checked').length > 0 ||
                                 document.querySelectorAll('.delete-video-checkbox:checked').length > 0;
                if (hasChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            }
        });
    </script>
</body>
</html>